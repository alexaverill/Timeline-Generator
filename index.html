<html>

<head>
    <script type="text/javascript">

        class Timeline {
            entries = [];
            constructor() {
                this.entries = [];
            }
            // addEntry(date,content){

            // }
            addEntry(entry) {
                this.entries.push(entry);
                this.sort();
            }
            sort() {
                this.entries = this.entries.sort(this.compare);
            }
            compare(d1, d2) {
                if (d1.date < d2.date) {
                    return -1;
                }
                if (d1.date > d2.date) {
                    return 1;
                }
                return 0;
            }
            getEntries() {
                return this.entries;
            }
        }
        class TimeElement {
            constructor(dateTime, content) {
                this.date = dateTime;
                this.content = content;
            }
        }
        var timeline = new Timeline();
        function loaded() {
            console.log("Loaded");
            //generateTimeline();
        }
        //TODO maybe refactor.
        function generateTimeline(entries) {

            let cssCode = document.getElementById('cssCode');
            let htmlCode = document.getElementById('htmlCode');
            let elements = entries;
            let latest = elements[elements.length - 1].date.getFullYear();
            let earliest = elements[0].date.getFullYear();
            let range = latest - earliest + 1;
            //generate CSS for elements.
            
            let tempRows = calculateTemplateRows(range);
            let timelineCSS = `height:50vh;\n
                               display: grid;\n 
                               grid-template-columns:30% 1% 30%;\n
                               grid-template-rows:${tempRows};\n`;
            let barCSS = `grid-column: 2/3;
                          grid-row: 1/${range*12};
                          border-radius: 10px;
                          background-color: red;`;
            let cssString = `.timeline{${timelineCSS}}\n;
                             .bar{${barCSS}} `;
            let cssEntries = [];
            
            for (let x = 0; x < elements.length; x++) {
                //calculate row pos;
                let pos = x + 1;
                let calculatedRow = (latest - elements[x].date.getFullYear()) * 12 + (12 - elements[x].date.getMonth());

                let rowPos = (calculatedRow + 1) + "/" + (calculatedRow + 2);
                console.log(elements[x].date + " " + rowPos);
                let colPos = "1/2";
                let alignment = "right";
                if (pos % 2 == 0) {
                    colPos = "3/4";
                    alignment = "left";
                }
                let innerCSS = `text-align:${alignment};\npadding:10;\ngrid-column:${colPos };\ngrid-row:${rowPos};\n`;
                cssEntries.push(innerCSS);
                cssString += `.t${x + 1}{\n${innerCSS}}\n`;
            }
            cssCode.innerText = cssString;
            //generate HTML for elements
            let htmlString = `<div class="timeline" id="timeline" style="${timelineCSS}"><div class="bar" style="${barCSS}`;
            let outputHTML = '<div class="timeline" id="timeline"><div class="bar"></div>';

            for (let x = 0; x < elements.length; x++) {
                let templatedString = `<div class="t${x + 1}" style="${cssEntries[x]}">
                                        <div class="timelineDate">${elements[x].date.toLocaleDateString("en-US")}</div>
                                        <div class="timelineContent">${elements[x].content}</div>
                                      </div>`;
                let outputString = `<div class="t${x + 1}>
                                        <div class="timelineDate">${elements[x].date.toLocaleDateString("en-US")}</div>
                                        <div class="timelineContent">${elements[x].content}</div>
                                      </div>`;
                outputHTML += outputString;
                htmlString += templatedString;
            }
            htmlString += '</div>';
            htmlCode.innerText = outputHTML;
            document.getElementById("timelinePreview").innerHTML += htmlString;
        }
        /// 
        /// Calculate number of rows needed by total number of years displayed.
        function calculateTemplateRows(years) {
            returnStr = ''; //need to double check on string immutibility in js.
            let percent = 100 / (years * 12);
            console.log(percent);
            for (let x = 0; x < (years * 12); x++) {
                returnStr += percent + "% ";
            }
            returnStr += ";";
            return returnStr;
        }
        function createDate() {
            let cont = document.createElement('div');
            cont.className = 'formElement';
            let label = document.createElement('label');
            label.setAttribute('for', 'date');
            label.innerText = "Date:";
            let date = document.createElement('input');
            date.type = 'date';
            date.name = 'date';

            cont.appendChild(label);
            cont.appendChild(date);
            return cont;
        }
        function createText() {
            let cont = document.createElement('div');
            cont.className = 'formElement';
            let tLabel = document.createElement('label');
            tLabel.setAttribute('for', 'desc');
            tLabel.innerText = "Content:";
            let text = document.createElement('textarea');
            text.name = 'desc';
            cont.appendChild(tLabel);
            cont.appendChild(text);
            return cont;
        }
        function addEntry() {
            let element = document.getElementById("entries");
            let container = document.createElement('div');
            container.className = "entry";
            container.appendChild(createDate());
            container.appendChild(createText());
            element.appendChild(container);
        }
        function processEntries() {
            let entries = document.getElementsByClassName("entry");
            //console.log(entries);
            //timelineEntries = [];
            for (let x = 0; x < entries.length; x++) {
                let time = entries[x].getElementsByTagName('input')[0].value;
                let content = entries[x].getElementsByTagName('textarea')[0].value;
                timeline.addEntry(new TimeElement(new Date(time), content));
            }


            generateTimeline(timeline.getEntries());
        }
    </script>
    <style>
        /* .timeline{
            display: grid;
            grid-template-columns: 30% 30% 30%;
            grid-template-rows: auto;
        }
        .timelineEntry{
            grid-column: 1/2;
        }
         */
        /* .timeline {
            height: 50vh;
            display: grid;
            grid-template-columns: 30% 1% 30%;
            grid-template-rows: 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667% 4.166666666666667%;
        } */
/* 
        .t1 {
            text-align: right;
            padding: 10;
            grid-column: 1/2;
            grid-row: 18/19;
        }

        .t2 {
            text-align: left;
            padding: 10;
            grid-column: 3/4;
            grid-row: 12/13;
        }

        .bar {
            grid-column: 2/3;
            grid-row: 1/all;
            border-radius: 10px;
            background-color: red;
        } */
    </style>
</head>

<body onload="loaded()">
    <div class="ui">
        <button type="button" onclick="addEntry()">Add Entry</button>
        <div id="entries" class="entries">
            <!-- <div class="formElement"><label for="date">Date:</label><input type="date" name="date"></div>
            <div class="formElement"><label for="content">Content:</label><textarea name="content"></textarea></div> -->
        </div>
        <button type="button" onclick="processEntries()">Generate Timeline</button>
        <code id="cssCode">

        </code>
        <code id="htmlCode">

        </code>
    </div>
    <div class="timelinePreview" id="timelinePreview">
        
    </div>

</body>

</html>